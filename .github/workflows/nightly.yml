name: Nightly Build and Publish

on:
  schedule:
    - cron: "0 3 * * *"  # Run daily at 3:00 AM UTC
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-publish-nightly:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine tomli

    - name: Update version with dev suffix
      run: |
        python << 'EOF'
        import re
        from datetime import datetime
        
        # Read current pyproject.toml
        with open('pyproject.toml', 'r') as f:
            content = f.read()
        
        # Extract current version
        version_match = re.search(r'version = "([^"]+)"', content)
        if not version_match:
            raise ValueError("Could not find version in pyproject.toml")
        
        current_version = version_match.group(1)
        
        # Remove any existing dev suffix if present
        base_version = re.sub(r'\.dev\d+$', '', current_version)
        
        # Generate dev version with date (YYYYMMDD format)
        date_suffix = datetime.utcnow().strftime('%Y%m%d')
        dev_version = f"{base_version}.dev{date_suffix}"
        
        # Replace version in content
        new_content = re.sub(
            r'version = "[^"]+"',
            f'version = "{dev_version}"',
            content
        )
        
        # Write back to pyproject.toml
        with open('pyproject.toml', 'w') as f:
            f.write(new_content)
        
        print(f"Updated version from {current_version} to {dev_version}")
        EOF

    - name: Build package
      run: |
        python -m build

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*


