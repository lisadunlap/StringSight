# Caddyfile for StringSight API
# Optimized for Vercel â†’ Digital Ocean connections
# Deploy this to your droplet at /etc/caddy/Caddyfile

api.stringsight.com {
    # Reverse proxy to your uvicorn backend
    reverse_proxy localhost:8000 {
        # Connection pooling - keeps connections alive
        transport http {
            keepalive 90s
            keepalive_idle_conns 10
        }

        # Health check to verify backend is up
        health_uri /health
        health_interval 30s
        health_timeout 5s
    }

    # CORS configuration for Vercel frontend
    @cors_preflight {
        method OPTIONS
    }

    # Handle CORS preflight quickly (this is KEY for performance!)
    handle @cors_preflight {
        header Access-Control-Allow-Origin "https://stringsight.vercel.app"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "DNT, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type, Range, Authorization"
        header Access-Control-Max-Age "86400"  # Cache preflight for 24 hours
        respond 204
    }

    # CORS headers for all responses
    header Access-Control-Allow-Origin "https://stringsight.vercel.app"
    header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "DNT, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type, Range, Authorization"
    header Access-Control-Expose-Headers "Content-Length, Content-Range"
    header Access-Control-Allow-Credentials "true"

    # Increase request size limit for file uploads
    request_body {
        max_size 100MB
    }

    # Enable compression for API responses
    encode gzip

    # Logging
    log {
        output file /var/log/caddy/stringsight.log
        format json
        level INFO
    }
}

# Optional: If you want to serve frontend from the same domain
# www.stringsight.com, stringsight.com {
#     root * /var/www/stringsight
#     file_server
#     try_files {path} /index.html
# }
